name: Build and Push Docker Images to GHCR

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Login to GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # --------------------------
      # Function to build & push
      # --------------------------
      - name: Build & Push Product.API
        run: |
          IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/product-api
          docker build -t $IMAGE:latest -t $IMAGE:${{ github.sha }} ./Product.API
          docker push $IMAGE:latest
          docker push $IMAGE:${{ github.sha }}

      - name: Make Product.API Public
        run: |
          curl -L \
            -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GHCR_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"visibility":"public"}' \
            https://api.github.com/user/packages/container/${{ secrets.GHCR_USERNAME }}%2Fproduct-api

      - name: Build & Push Order.API
        run: |
          IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/order-api
          docker build -t $IMAGE:latest -t $IMAGE:${{ github.sha }} ./Order.API
          docker push $IMAGE:latest
          docker push $IMAGE:${{ github.sha }}

      - name: Make Order.API Public
        run: |
          curl -L \
            -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GHCR_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"visibility":"public"}' \
            https://api.github.com/user/packages/container/${{ secrets.GHCR_USERNAME }}%2Forder-api

      - name: Build & Push Customer.API
        run: |
          IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/customer-api
          docker build -t $IMAGE:latest -t $IMAGE:${{ github.sha }} ./Customer.API
          docker push $IMAGE:latest
          docker push $IMAGE:${{ github.sha }}

      - name: Make Customer.API Public
        run: |
          curl -L \
            -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GHCR_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"visibility":"public"}' \
            https://api.github.com/user/packages/container/${{ secrets.GHCR_USERNAME }}%2Fcustomer-api

      - name: Build & Push ApiGateway
        run: |
          IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/api-gateway
          docker build -t $IMAGE:latest -t $IMAGE:${{ github.sha }} ./ApiGateway
          docker push $IMAGE:latest
          docker push $IMAGE:${{ github.sha }}

      - name: Make ApiGateway Public
        run: |
          curl -L \
            -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GHCR_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"visibility":"public"}' \
            https://api.github.com/user/packages/container/${{ secrets.GHCR_USERNAME }}%2Fapi-gateway
